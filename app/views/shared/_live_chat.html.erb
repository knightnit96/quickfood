<% if @orders_shipper_user.present? %>
  <% list = "" %>
  <% @orders_shipper_user.each do |order| %>
    <% list += order.id.to_s+"," %>
  <% end %>
  <div id="list_order_js" data-list="<%= list %>"></div>
  <% counter = 0 %>
  <% @orders_shipper_user.each do |order| %>
    <% if order.status == 4 || order.status == 5 %>
    <% else %>
      <% @messages = Message.by_order order.id %>
      <% if @messages.present? %>
        <% @address = Address.find_by id: order.address_id %>
        <div id="live-chat" style="margin-right: <%= counter*320 %>px">
          <div class="header <% if cookies["notify_chat_order_"+order.id.to_s] == "1" %>quadrat<% end %>" id="header_notify_<%= order.id %>" data-id="<%= order.id %>">
            <h4>Chat - Đơn hàng #<%= order.id %></h4>
          </div>
          <% style = "display: block;" %>
          <% if cookies["chat_order_"+order.id.to_s].present? %>
            <% if cookies["chat_order_"+order.id.to_s] == "1" %>
               <% style = "display: none;" %>
            <% end %>
          <% end %>
          <div class="chat" id="live_chat_<%= order.id %>" style="<%= style %>">
            <div class="chat-history" id="history_live_chat_<%= order.id %>">
              <% @messages.each do |message| %>
                <% user = User.find_by id: message.user_id %>
                <div class="chat-message clearfix">
                  <% if message.user_id.present? %>
                    <%= image_tag user.avatar_url, width: "32", height: "32" %>
                  <% else %>
                    <%= image_tag "/assets/img/default-avatar.jpg", width: "32", height: "32" %>
                  <% end %>
                  <div class="chat-message-content clearfix">
                    <span class="chat-time"><%= l message.created_at, format: :short %></span>
                    <h5><strong>
                      <% if message.user_id.present? %>
                        <% if message.is_shipper  == false %>
                          <%= user.name %>
                        <% else %>
                          [Shipper] <%= user.name %>
                        <% end %>
                      <% else %>
                        HỆ THỐNG
                      <% end %>
                    </strong></h5>
                    <p><%= message.message %></p>
                  </div>
                </div>
                <hr>
              <% end %>
            </div>
            <!-- end chat-history -->
            <hr>
            <%= form_tag add_message_places_path, method: :post, class: "form_message" do %>
              <fieldset>
                <input type="text" id="chat_content" name="chat_content" placeholder="Nhập nội dung chat" autofocus>
                <%= hidden_field_tag "order_id", order.id %>
              </fieldset>
            <% end %>
            <hr>
            <div class="row" style="margin-bottom: 10px;">
              <div class="col-md-12 text-center">
                <button data-toggle="modal" data-target="#modal_detail_order_<%= order.id %>" class="btn_1"><%= t ".order" %></button>
                <% @place = Place.find_by id: order.place_id %>
                <% @shipper_info = Shipper.find_by id: order.shipper_id %>
                <% latitude_shipper = "" %>
                <% longitude_shipper = "" %>
                <% if @shipper_info.present? %>
                  <% latitude_shipper = @shipper_info.latitude %>
                  <% longitude_shipper = @shipper_info.longitude %>
                <% end %>
                <button data-toggle="modal" data-target="#modal_detail_map" class="btn_1 click_map" id="map_order_message_<%= order.id %>" data-id="<%= order.id %>" data-latitude-user="<%= @address.latitude %>" data-longitude-user="<%= @address.longitude %>" data-latitude-place="<%= @place.latitude %>" data-longitude-place="<%= @place.longitude %>" data-latitude-shipper="<%= latitude_shipper %>" data-longitude-shipper="<%= longitude_shipper %>"><%= t ".map" %></button>
                <button class="btn_1 click_cancel_order" data-id="<%= order.id %>"><%= t ".cancel" %></button>
              </div>
            </div>
            <% if @shipper.present? %>
              <hr>
              <div class="row" style="margin-bottom: 10px;">
                <div class="col-md-12 text-center btn_confirm_shipper">
                  <% if order.status == 3 %>
                    <button class="btn_1 click_update_order" data-id="<%= order.id %>" data-value="4" data-title="Đơn hàng thành công! Xác nhận?"><%= t ".delivered" %></button>
                  <% else %>
                    <button class="btn_1 click_update_order" data-id="<%= order.id %>" data-value="3" data-title="Đã nhận được hàng! Xác nhận?"><%= t ".received" %></button>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          <!-- end chat -->
        </div>
        <!-- end live-chat -->
        <div class="modal fade" id="modal_detail_order_<%= order.id %>" tabindex="-1" role="dialog" aria-labelledby="myLogin" aria-hidden="true">
          <div class="modal-dialog">
            <div class="box_style_2">
              <h2 class="inner">Chi tiết đơn hàng</h2>
              <div id="confirm">
                <h3>Địa chỉ người nhận</h3>
                <p>
                  Địa chỉ: <%= @address.address %>
                </p>
                <p>
                  Người nhận: <%= @address.name %>
                </p>
                <p>
                  SĐT: <%= @address.phone %>
                </p>
              </div>
              <h4>Tóm lược</h4>
              <table class="table table-striped nomargin">
                <tbody>
                  <% @product_orders = ProductOrder.by_order(order.id).by_parent nil %>
                  <% @product_orders.each do |po| %>
                    <tr>
                      <td>
                        <strong><%= po.quantity %> x </strong> <%= po.food_name %>
                      </td>
                      <td>
                        <strong class="pull-right"><%= number_to_currency_format po.actual_price %></strong>
                      </td>
                    </tr>
                    <% @product_orders_option = ProductOrder.by_parent po.id %>
                    <% @product_orders_option.each do |poo| %>
                      <tr>
                        <td>
                          <strong> + </strong> <%= poo.food_name %>
                        </td>
                        <td>
                          <strong class="pull-right"><%= number_to_currency_format poo.actual_price %></strong>
                        </td>
                      </tr>
                    <% end %>
                  <% end %>
                  <tr>
                    <td>
                      <strong>Tổng món</strong>
                    </td>
                    <td>
                      <strong class="pull-right"><%= number_to_currency_format order.total_price+order.fee %></strong>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <strong>Phí vận chuyển</strong>
                    </td>
                    <td>
                      <strong class="pull-right"><%= number_to_currency_format order.fee %></strong>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      Lịch trình vận chuyển <a href="#" class="tooltip-1" data-placement="top" title="" data-original-title="Vui lòng xem xét chờ khoảng 20 phút cho việc giao hàng!"><i class="icon_question_alt"></i></a>
                    </td>
                    <td>
                      <strong class="pull-right"><%= l order.created_at + 20.minutes, format: :short %></strong>
                    </td>
                  </tr>
                  <tr>
                    <td class="total_confirm">
                      TỔNG
                    </td>
                    <td class="total_confirm">
                      <span class="pull-right"><%= number_to_currency_format order.total_price+order.fee %></span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal fade" id="modal_detail_map" tabindex="-1" role="dialog" aria-labelledby="myLogin" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content modal-popup">
              <div id="map5" class="is_map"></div>
            </div>
          </div>
        </div>
        <%= javascript_include_tag "map_order" %>
        <% counter += 1 %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

<%= javascript_include_tag "live_chat" %>
